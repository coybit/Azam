<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
  <meta name="description" content="">
  <meta name="author" content="">
  <link rel="icon" href="https://github.com/coybit/Azam/raw/master/img/azam.ico">

  <title>Azam</title>
  <link href="https://v4-alpha.getbootstrap.com/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://v4-alpha.getbootstrap.com/assets/js/ie10-viewport-bug-workaround.js"></script>
  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lunr.js/1.0.0/lunr.min.js" charset="utf-8"></script>

  <style media="screen">
  body {
    background: #fff;
  }

  .movie {
    margin: 10px 0;
    background: #f7f7f7;
    padding: 16px;
    border-radius: 4px;
  }

  .movie-title {
    font-size: 28px;
    float: left;
  }

  .movie-rate {
    font-size: 20px;
    float: right;
  }

  .movie-image {
    height: 200px;
    float: left;
    padding-right: 32px;
  }

  .movie-genre {
    display: block;
    margin: 0 10px;
    left: 10px;
    float: right;
    background: #d8d8d8;
    padding: 2px 8px;
    border-radius: 4px;
  }

  .movie-plot {
    display: block;
    margin-top: 60px;
    line-height: 30px;
    height: 140px;
    margin-right: 20px;
    overflow: hidden;;
  }

  .clearfix::after {
    content: " ";
    display: block;
    height: 0;
    clear: both;
  }

  .search-box {
    width: 100%;
    height: 40px;
    padding: 0 10px;
    margin: 30px 0;
  }

  .search-box:focus {
    outline: none;
  }

  a {
    cursor: pointer;
  }

  </style>
</head>

<body>
  <nav class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <a href="mailto:coybit@gmail.com?Subject=Azam" target="_top">
        <img src="https://github.com/coybit/Azam/raw/master/img/wish.png" width="36">
      </a>
    </div>
  </nav>

  <div class="container">

    <div class="row">
      <div class="col-lg-12">
        <div style="text-align: center;">
          <img src="https://github.com/coybit/Azam/raw/master/img/azam.png" width="100">
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-lg-12">
        <input type="text" placeholder="Search in title, plot and genre ..." class="search-box"/>
      </div>
    </div>

    <div class="row">
      <div class="col-lg-12">
        <div id="list"></div>
      </div>
    </div>

  </div> <!-- /container -->

  <script type="text/javascript">

  var movies = [];

  var idx = lunr(function () {
    this.field('title', { boost: 10 })
    this.field('plot')
    this.field('genre')
    this.field('actors')
    this.field('director')
    this.field('year')
  })

  $.get( 'out.json', function(res) {

    movies = prepare(res);
    search('', movies);

  })

  ///////// Event Handlers
  $('.search-box').on('keyup', function() {
    var term = $('.search-box').val().toLowerCase();
    search(term, movies);
  });


  ///////// Utilities

  function prepare(rawList) {

    var list = rawList.map(function(movie){

      // Extract Rate
      var rate = [0];
      if( movie.info.Ratings ) {
        rate = movie.info.Ratings.filter(function(rate){
          return rate.Source == "Internet Movie Database"
        }).map( function(rate) { return rate.Value });
      }

      if( rate.length == 0 ) {
        rate = [0];
      }

      // Map
      return {
        "title": movie.info.Title,
        "rate": rate[0],
        "image": movie.info.Poster,
        "genre": movie.info.Genre,
        "plot": movie.info.Plot,
        "director": movie.info.Director,
        "actors": movie.info.Actors,
        "year": movie.info.Year,
      }
    }).filter( function(movie) {
      return movie.title != null;
    });

    list.forEach( function(item,index) {

      var doc = {
        "title": item.title,
        "plot": item.plot,
        "director": item.director,
        "genre": item.genre,
        "actors": item.actors,
        "year": item.year,
        "id": index
      }
      idx.add(doc);

    });

    return list;
  }

  function search(term,movies) {

    $('#list').html('').hide();

    var results;

    if( term == '' ) { // Show all movies
      results = movies;
    }
    else {
      results = idx.search(term).map( function(result) {
        return movies[result.ref];
      });
    }

    results.forEach( function(movie) {

      var elmImage = $('<img>').addClass('movie-image').attr('src',movie.image);
      var elmTitle = $('<span>').addClass('movie-title').text(movie.title);
      var elmScore = $('<span>').addClass('movie-rate').text(movie.rate);
      var elmGenre = $('<span>').addClass('movie-genre').text(movie.genre);
      var elmPlot = $('<span>').addClass('movie-plot').text(movie.plot);

      var elm = $('<div>').addClass('movie clearfix')
      .append(elmImage)
      .append(elmTitle)
      .append(elmScore)
      .append(elmGenre)
      .append(elmPlot);

      $('#list').append( elm );

    });

    $('#list').show();

  }

  </script>

</body>
</html>
